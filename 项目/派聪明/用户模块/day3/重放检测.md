
---

## 一句话定义（面试版）

> **重放检测** 是指通过识别同一个令牌（通常是 Refresh Token）被重复使用的行为，来判断令牌是否被复制或盗用，从而触发安全处置的机制。

---

## 一、为什么需要重放检测？（问题背景）

### JWT + Refresh Token 的致命风险

- Refresh Token 生命周期长
    
- 一旦被盗，攻击者可以：
    
    - 在很长时间内反复刷新 Access Token
        
    - 服务器**无法区分“本人使用”还是“攻击者使用”**
        

👉 **“被复制但还能用”** 是最危险的状态。

---

## 二、重放检测要解决的核心问题

> **同一个 Refresh Token，理论上只能被“使用一次”。**

如果：

- 同一个 refresh 被用 **第二次**
    
- 且不是因为系统错误
    

👉 **那几乎可以确定发生了盗用 / 复制（Replay）**

---

## 三、重放检测的基本思路（核心机制）

### 关键原则

> **一次性令牌（One-Time Token） + 使用痕迹记录**

---

### 典型做法（最常见）

1. 每个 Refresh Token 都有唯一标识 `jti`
    
2. Redis 中维护两类数据：
    
    - **当前有效 refresh**（白名单）
        
    - **已使用 refresh**（used / 黑名单，短期）
        

---

## 四、一个最清晰的流程示例

### Redis 结构示意

```text
refresh:current:{jti} = userId     (TTL = 7d)
refresh:used:{jti}    = 1          (TTL = 1d)
```

---

### 刷新请求到来时

#### Step 1：解析 jti

```text
jti = extractJti(refreshToken)
```

---

#### Step 2：查「已使用集合」（重放检测的核心）

```text
if exists(refresh:used:jti):
    → 判定为重放攻击
```

👉 **这一步命中，直接是强信号**

---

#### Step 3：查「当前有效 refresh」

```text
if not exists(refresh:current:jti):
    → 非法 / 过期 / 已吊销
```

---

#### Step 4：正常轮转

```text
DEL refresh:current:jti
SET refresh:used:jti EX 1d
SET refresh:current:newJti EX 7d
```

👉 **旧的进入 used，新的一次性生效**

---

## 五、为什么要有「used 集合」？（非常重要）

你可能会问：

> 只要把旧 refresh 删掉不就行了吗？

不够。

### 没有 used 集合的问题

- Redis miss：
    
    - 可能是过期
        
    - 可能是被吊销
        
    - 也可能是被用过
        

👉 **无法区分“正常失效”和“重放”**

---

### used 集合的价值

- **miss + 在 used 里出现 = 100% 重放**
    
- 是一种**可证明的异常**
    

---

## 六、检测到重放后，通常怎么处理？（企业级）

一旦判定重放：

1. 撤销该用户 **所有 refresh token（全端下线）**
    
2. 撤销 access token（若有白名单）
    
3. 记录安全日志 / 风控事件
    
4. 强制重新登录
    
5. （可选）要求二次验证（2FA）
    

---

## 七、重放检测 ≠ 防止重放（区分点）

这是个**面试加分点**。

- **防止重放**：
    
    - HTTPS
        
    - 短时 token
        
- **重放检测**：
    
    - 发现已经发生的复制/滥用
        
    - 并及时止损
        

👉 检测是**事中 / 事后控制**

---

## 八、并发刷新和重放检测的关系（你刚学的）

- 并发刷新 ≠ 重放攻击
    
- 如果不做原子操作，很容易：
    
    - 把并发刷新误判为重放
        

👉 所以：

- **原子轮转**
    
- **再加重放检测**
    

是一个组合拳。

---

## 九、面试标准回答（30 秒）

> 重放检测是通过记录 Refresh Token 的使用痕迹，来识别同一个令牌被重复使用的行为。通常会为每个 Refresh Token 分配唯一标识，并在使用后将其标记为已使用，如果后续再次出现相同标识，就可以判定为重放，从而触发安全处置，比如全端下线或强制重新登录。这种机制常与令牌轮转一起使用，用来降低 Refresh Token 泄露后的风险。

---

## 十、你现在的水平评价（实话）

你已经能把下面四件事**完整串起来**了：

- JWT 的无状态问题
    
- Redis 的状态补偿
    
- 令牌轮转
    
- 重放检测
    

👉 **这已经是“成熟鉴权设计”的完整链路**

---
