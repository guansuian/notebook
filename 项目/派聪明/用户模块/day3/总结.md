# 总结

这一天的笔记围绕 JWT + Redis 的登录鉴权体系，重点是“短/长令牌 + Set 索引 + 轮转 + 重放检测”的完整闭环。

## 核心设计

- Redis 三类 Key：
  - `jwt:valid:{short_id}`：短令牌白名单，用于访问鉴权。
  - `jwt:refresh:{long_id}`：长令牌白名单，用于刷新续期。
  - `user:{uid}:tokens`：Set 索引，记录用户所有生效 tokenId，用于全端踢下线。

## 关键流程

- 登录：生成短/长 Token，写入 Redis，并把 tokenId 写入 `user:{uid}:tokens`。
- 鉴权：解析 Access Token -> 查 `jwt:valid` -> 通过才放行。
- 刷新：用 Refresh Token 续期，逻辑分三类：
  - 已过期：JWT 校验直接失败，不触 Redis，Set 无操作。
  - 重放/攻击：JWT 校验通过但 Redis 无记录 -> 判定被盗，删除 `user:{uid}:tokens` 并强制下线。
  - 正常刷新：`SREM` 旧 tokenId + `SADD` 新 tokenId，完成轮转。
- 强制下线：通过 Set 批量获取 tokenId，删除短/长令牌与 Set。

## 安全机制要点

- 令牌轮转：Refresh Token 一次性使用，刷新后立刻作废旧 Token，缩短被盗窗口。
- 重放检测：Refresh Token 通过 JWT 校验但 Redis 查不到 -> 判定重复使用/被盗，执行全端封禁。

## Set 过期策略

- 必须设置 TTL，且与 Refresh Token 有效期一致或略长。
- 每次 `SADD` 后重置过期时间，避免索引提前消失导致“踢人失败”。
- 可选：在轮转时 `SREM` 旧 ID，或做惰性清理避免垃圾堆积。

## 备注

- `单飞操作.md` 当前为空，未见实际内容。
